<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ============================================================ -->
    <!-- MY ADDRESSES - Portal Page                                    -->
    <!-- ============================================================ -->
    <template id="portal_my_addresses" name="My Addresses">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Mis Direcciones de Entrega</t>
            </t>
            
            <div class="o_portal_my_doc_list o_portal_cards py-4">
                <!-- Success/Error Messages -->
                <t t-if="request.params.get('success')">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fa fa-check-circle me-2"></i>
                        <t t-if="request.params.get('success') == 'saved'">Dirección guardada correctamente.</t>
                        <t t-if="request.params.get('success') == 'deleted'">Dirección eliminada correctamente.</t>
                        <t t-if="request.params.get('success') == 'default_set'">Dirección predeterminada actualizada.</t>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </t>
                <t t-if="request.params.get('error')">
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fa fa-exclamation-circle me-2"></i>
                        <t t-if="request.params.get('error') == 'cannot_delete_main'">No puedes eliminar tu dirección principal.</t>
                        <t t-if="request.params.get('error') == 'access_denied'">No tienes permiso para realizar esta acción.</t>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </t>
                
                <!-- Header with Add Button -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">Direcciones de Entrega</h3>
                    <a href="/my/addresses/add" class="btn btn-primary rounded-pill">
                        <i class="fa fa-plus me-2"></i>Agregar Dirección
                    </a>
                </div>
                
                <!-- Address Cards Grid -->
                <div class="row g-4">
                    <t t-if="addresses">
                        <t t-foreach="addresses" t-as="address">
                            <div class="col-md-6 col-lg-4">
                                <div t-attf-class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden #{address.id == current_shipping_id and 'border-primary border-2' or ''}">
                                    <!-- Card Header -->
                                    <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center py-2 px-3">
                                        <span class="badge rounded-pill" t-attf-style="background: var(--o-color-primary, #007bff);">
                                            <i t-attf-class="fa #{address.type == 'delivery' and 'fa-truck' or 'fa-home'} me-1"></i>
                                            <t t-if="address.type == 'delivery'">Entrega</t>
                                            <t t-elif="address.type == 'invoice'">Facturación</t>
                                            <t t-else="">Principal</t>
                                        </span>
                                        <t t-if="address.id == current_shipping_id">
                                            <span class="badge bg-success rounded-pill">
                                                <i class="fa fa-check me-1"></i>Activa
                                            </span>
                                        </t>
                                    </div>
                                    
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <h6 class="fw-bold mb-2" t-esc="address.name"/>
                                        <p class="text-muted small mb-1">
                                            <i class="fa fa-map-marker me-2"></i>
                                            <t t-esc="address.street"/>
                                            <t t-if="address.street2">, <t t-esc="address.street2"/></t>
                                        </p>
                                        <p class="text-muted small mb-1">
                                            <t t-esc="address.city"/>
                                            <t t-if="address.state_id">, <t t-esc="address.state_id.name"/></t>
                                            <t t-if="address.zip"> - <t t-esc="address.zip"/></t>
                                        </p>
                                        <p class="text-muted small mb-0" t-if="address.country_id">
                                            <t t-esc="address.country_id.name"/>
                                        </p>
                                        <p class="small mb-0" t-if="address.phone">
                                            <i class="fa fa-phone me-2 text-muted"></i>
                                            <t t-esc="address.phone"/>
                                        </p>
                                    </div>
                                    
                                    <!-- Card Footer Actions -->
                                    <div class="card-footer bg-transparent border-top-0 d-flex gap-2 justify-content-end p-3">
                                        <t t-if="address.id != current_shipping_id">
                                            <form t-attf-action="/my/addresses/set_default/#{address.id}" method="post" class="d-inline">
                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill" title="Usar esta dirección">
                                                    <i class="fa fa-check"></i>
                                                </button>
                                            </form>
                                        </t>
                                        <a t-attf-href="/my/addresses/edit/#{address.id}" class="btn btn-sm btn-outline-secondary rounded-pill" title="Editar">
                                            <i class="fa fa-pencil"></i>
                                        </a>
                                        <t t-if="address.parent_id">
                                            <form t-attf-action="/my/addresses/delete/#{address.id}" method="post" class="d-inline" 
                                                  onsubmit="return confirm('¿Seguro que deseas eliminar esta dirección?');">
                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill" title="Eliminar">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </form>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </t>
                    <t t-else="">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm rounded-4 p-5 text-center bg-light">
                                <i class="fa fa-map-marker text-muted mb-3" style="font-size: 4rem;"></i>
                                <h4 class="text-muted">No tienes direcciones guardadas</h4>
                                <p class="text-muted mb-4">Agrega una dirección de entrega para facilitar tus compras.</p>
                                <a href="/my/addresses/add" class="btn btn-primary rounded-pill mx-auto" style="max-width: 200px;">
                                    <i class="fa fa-plus me-2"></i>Agregar Dirección
                                </a>
                            </div>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- ============================================================ -->
    <!-- ADDRESS FORM - Add/Edit Page                                  -->
    <!-- ============================================================ -->
    <template id="portal_address_form" name="Address Form">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">
                    <t t-if="mode == 'create'">Nueva Dirección</t>
                    <t t-else="">Editar Dirección</t>
                </t>
            </t>
            
            <div class="o_portal_my_doc_list py-4">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-primary text-white rounded-top-4 py-3">
                                <h5 class="mb-0">
                                    <i class="fa fa-map-marker me-2"></i>
                                    <t t-if="mode == 'create'">Nueva Dirección de Entrega</t>
                                    <t t-else="">Editar Dirección de Entrega</t>
                                </h5>
                            </div>
                            <div class="card-body p-4">
                                <form t-attf-action="#{mode == 'create' and '/my/addresses/add' or '/my/addresses/edit/' + str(address.id)}" method="post">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                    
                                    <!-- Name -->
                                    <div class="mb-3">
                                        <label for="name" class="form-label fw-bold">Nombre del destinatario <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control rounded-pill" id="name" name="name" required=""
                                               t-att-value="address.name if address else request.env.user.partner_id.name"/>
                                    </div>
                                    
                                    <!-- Street -->
                                    <div class="mb-3">
                                        <label for="street" class="form-label fw-bold">Dirección <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control rounded-pill" id="street" name="street" required=""
                                               placeholder="Calle, Número, Edificio..."
                                               t-att-value="address.street if address else ''"/>
                                    </div>
                                    
                                    <!-- Street 2 -->
                                    <div class="mb-3">
                                        <label for="street2" class="form-label">Dirección 2 (opcional)</label>
                                        <input type="text" class="form-control rounded-pill" id="street2" name="street2"
                                               placeholder="Apartamento, Piso, Referencia..."
                                               t-att-value="address.street2 if address else ''"/>
                                    </div>
                                    
                                    <!-- City + State Row -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3 mb-md-0">
                                            <label for="city" class="form-label fw-bold">Ciudad <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control rounded-pill" id="city" name="city" required=""
                                                   t-att-value="address.city if address else ''"/>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="state_id" class="form-label fw-bold">Estado / Provincia</label>
                                            <select class="form-select rounded-pill" id="state_id" name="state_id">
                                                <option value="">Seleccionar...</option>
                                                <t t-foreach="states" t-as="state">
                                                    <option t-att-value="state.id" 
                                                            t-att-selected="address and address.state_id.id == state.id"
                                                            t-att-data-country="state.country_id.id">
                                                        <t t-esc="state.name"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Zip + Country Row -->
                                    <div class="row mb-3">
                                        <div class="col-md-4 mb-3 mb-md-0">
                                            <label for="zip" class="form-label">Código Postal</label>
                                            <input type="text" class="form-control rounded-pill" id="zip" name="zip"
                                                   t-att-value="address.zip if address else ''"/>
                                        </div>
                                        <div class="col-md-8">
                                            <label for="country_id" class="form-label fw-bold">País <span class="text-danger">*</span></label>
                                            <select class="form-select rounded-pill" id="country_id" name="country_id" required="">
                                                <option value="">Seleccionar país...</option>
                                                <t t-foreach="countries" t-as="country">
                                                    <option t-att-value="country.id" 
                                                            t-att-selected="address and address.country_id.id == country.id">
                                                        <t t-esc="country.name"/>
                                                    </option>
                                                </t>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Phone -->
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control rounded-pill" id="phone" name="phone"
                                               placeholder="+58 412 123 4567"
                                               t-att-value="address.phone if address else ''"/>
                                    </div>
                                    
                                    <!-- Set as Default -->
                                    <div class="mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="set_as_default" name="set_as_default" value="1"/>
                                            <label class="form-check-label" for="set_as_default">
                                                Usar como dirección predeterminada de entrega
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="d-flex gap-2 justify-content-between">
                                        <a href="/my/addresses" class="btn btn-outline-secondary rounded-pill px-4">
                                            <i class="fa fa-arrow-left me-2"></i>Cancelar
                                        </a>
                                        <button type="submit" class="btn btn-primary rounded-pill px-4">
                                            <i class="fa fa-save me-2"></i>Guardar Dirección
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ============================================================ -->
    <!-- Add "My Addresses" Link to Portal Sidebar                     -->
    <!-- ============================================================ -->
    <template id="portal_my_home_addresses_link" inherit_id="portal.portal_my_home" name="Portal Addresses Link">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <div class="col-12 mb-3">
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-body p-3 d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white" style="width: 48px; height: 48px;">
                            <i class="fa fa-map-marker fa-lg"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 fw-bold">Direcciones de Entrega</h6>
                            <small class="text-muted">Gestiona tus direcciones de envío</small>
                        </div>
                        <a href="/my/addresses" class="btn btn-outline-primary rounded-pill btn-sm">
                            Administrar <i class="fa fa-chevron-right ms-2"></i>
                        </a>
                    </div>
                </div>
            </div>
        </xpath>
    </template>
</odoo>
